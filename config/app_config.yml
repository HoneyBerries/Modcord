# ========================================
# MODCORD CONFIGURATION
# ========================================
# This configuration file defines all settings for Modcord, including AI/LLM tuning,
# moderation behavior, and cache refresh intervals.
#
# Sections:
#   1. Cache & Performance Settings
#   2. AI Model & Inference Settings
#   3. Moderation System Prompt
#   4. Default Rules & Guidelines

# ========================================
# 1. CACHE & PERFORMANCE SETTINGS
# ========================================

rules_cache_refresh:
  # Interval (seconds) to refresh server rules and channel guidelines from Discord.
  # Recommended: 3600 (60 minutes). Lower values increase API calls and latency.
  # Higher values reduce API load but may miss fast rule updates.
  interval_seconds: 3600

# ========================================
# 2. AI MODEL & INFERENCE SETTINGS
# ========================================

ai_settings:
  # Enable/disable AI-based moderation. Set to false to use basic moderation.
  enabled: true

  # Path to your local model directory or Hugging Face model identifier.
  # Examples:
  #   - Local: "./modcord_custom_models/qwen3-vl-4b-instruct-nf4"
  #   - HuggingFace: "Qwen/Qwen3-VL-4B-Instruct"
  model_id: "cpatonn/Qwen3-VL-4B-Instruct-AWQ-4bit"

  # GPU memory utilization (0.0 to 1.0).
  # 0.86 = use 86% of GPU VRAM. Reduce if running out of memory.
  vram_percentage: 0.86

  # CPU offload size in GB (used when model exceeds available GPU memory).
  # Set to 0 to disable offloading. Increase if model doesn't fit in VRAM.
  cpu_offload_gb: 0

  # Moderation batch window (seconds).
  # Messages received within this window are grouped for batch moderation.
  # Lower values = faster response (more API calls), higher values = better efficiency.
  moderation_batch_seconds: 15

  # Historical context lookback (days) for past moderation actions.
  # When processing current violations, include actions from the past N days.
  # Default: 7 (7 days). Set to 0 to disable context lookback.
  # This helps the AI understand a user's moderation history when making decisions.
  past_actions_lookback_days: 7

  # Number of recent messages to fetch for context when building message history.
  # Higher values provide more context for violations but increase processing time.
  # Recommended: 8-20. Adjust based on channel activity level.
  history_context_messages: 8

  # Sampling parameters for text generation.
  # These control model behavior, creativity, and output quality.
  sampling_parameters:
    # Data type for model computation.
    # Options: "auto" (default), "float32", "float16" (half), "bfloat16" (better than float16).
    dtype: "bfloat16"

    # Maximum number of tokens to generate in a single inference.
    # Higher = more verbose output but slower. Moderation typically needs ~256-512 tokens.
    max_new_tokens: 512

    # Maximum total model context length (input + output tokens).
    # Ensure this is <= model's actual context window.
    # Qwen3-VL-4B: 4096-8192 tokens recommended.
    max_model_length: 4096

    # Temperature (0.0-1.5): Controls randomness/creativity.
    # 0.0 = deterministic (guranteed same output every time)
    # 0.3 = balanced (default)
    # 0.7 = more creative/random
    # For moderation: 0.3 (somewhat deterministic) is recommended.
    temperature: 0.3

    # Top-P (nucleus sampling): Keep only top P% probability mass.
    # 0.9 = keep top 90% of probable tokens, drop bottom 10%.
    # Higher values = more diverse output, lower = more focused.
    top_p: 0.9

    # Top-K: Keep only top K most probable tokens.
    # 40 = consider only top 40 tokens at each step.
    # Lower = more focused, higher = more diverse.
    top_k: 40

    # Repetition penalty: Penalizes repeated tokens.
    # 1.0 = no penalty, >1.0 = penalize repetition.
    # 1.1 is good for avoiding repetitive/spam-like output.
    repetition_penalty: 1.1

    # Presence penalty: Penalizes tokens that have already appeared.
    # 0.0 = disabled, >0.0 = penalize already-used tokens.
    presence_penalty: 0.0

    # Frequency penalty: Penalizes tokens proportional to their frequency.
    # 0.0 = disabled, >0.0 = penalize high-frequency tokens.
    frequency_penalty: 0.0

  # System prompt for the AI moderation model.
  # This guides the model to make moderation decisions in JSON format.
  # Injected placeholders:
  #   <|SERVER_RULES_INJECT|> → Replaced with server_rules or default_server_rules
  #   <|CHANNEL_GUIDELINES_INJECT|> → Replaced with channel-specific guidelines
  system_prompt: |
    ROLE: You are a Discord moderation AI. Output ONLY valid JSON. No explanations, no extra text.

    INPUT:
    - Consider the JSON input containing channel_id, users, and messages.
    - Only process current messages (is_history: false). 
    - Historical messages provide context ONLY; they must NOT be used as evidence of a violation.
    - A user may ONLY be moderated if their CURRENT messages violate a rule.

    USER DATA:
    Each user object contains:
    - user_id: Discord user ID
    - username: Display name
    - roles: List of role names
    - join_date: When they joined the server
    - messages: Array of messages with content, timestamp, and image_ids
    - past_actions: Past moderation actions taken on this user
      * Use past_actions ONLY to determine escalation IF AND ONLY IF a new violation exists.
      * Never punish a user solely because they have past actions.

    USER ACTIONS:
    - One action per user.
    - Include all users; if no violation, use "action": "null".
    - Valid actions:
      - "null" → no violation or ambiguous
      - "warn" → first-time significant violation
      - "delete" → remove specific current messages that violate rules
      - "timeout" → repeated violations (must set timeout_duration in minutes)
      - "kick" → serious violation
      - "ban" → repeated serious violations (set ban_duration; -1 = permanent)

    STRICT RULE:  
    - **Short**, **casual**, **unremarkable**, or **low-effort** messages are NOT violations unless they explicitly break a listed rule.  
    - NEVER classify normal conversation as spam unless it CLEARLY meets the server’s definition.

    RULES & POLICIES:
    Follow ONLY the rules below exactly as written. Do not infer extra rules. Be lenient to avoid false positives.

    --- Discord Server Rules ---
    <|SERVER_RULES_INJECT|>

    --- Channel-Specific Guidelines ---
    <|CHANNEL_GUIDELINES_INJECT|>

    OUTPUT FORMAT:
    {
      "channel_id": "string",
      "users": [
        {
          "user_id": "string",
          "action": "null|warn|delete|timeout|kick|ban",
          "reason": "factual, concise",
          "message_ids_to_delete": ["current IDs only"],
          "timeout_duration": number|0,
          "ban_duration": number|0
        }
      ]
    }

    PROCEDURE:
    1. Ignore all historical messages (is_history=true) for rule-breaking evaluation.
    2. Evaluate ONLY current messages against server rules.
    3. If no current messages, set "action": "null".
    4. If a current message breaks a rule:
      - First violation → "warn"
      - If user has past similar violations → escalate (timeout, kick, ban)
    5. If NO rule is violated → ALWAYS "action": "null", regardless of past actions.
    6. If uncertain that a rule was broken → choose "null" (benefit of the doubt).

    ANTI-BIAS:
    - Do not assume intent.
    - Do not judge users based on message length, frequency, tone, or writing style unless explicitly required by a rule.
    - Escalate ONLY when a new violation is detected.


# ========================================
# 4. DEFAULT RULES & GUIDELINES
# ========================================
# These are template rules that apply to all servers unless overridden per-guild.
# To customize per-guild, use the Discord bot commands to set server-specific rules.

# Default server rules for all servers.
# Used when a server hasn't defined custom rules via the bot.
# Rules are displayed to users and used by the AI moderation model.
default_server_rules: |
  1. Be respectful to all members and moderators.
  2. No spamming, flooding, or excessive use of caps/emoji. (Minor: occasional caps/emoji; Major: repeated spamming)
  3. No hate speech, racism, sexism, homophobia, or any form of discrimination. (Always major)
  4. Keep content appropriate for all ages; no NSFW, graphic violence, or illegal content. (Always major)
  5. Do not share personal information of yourself or others. (Always major)
  6. Follow Discord's Terms of Service and community guidelines. (Major if violated)
  7. Do not advertise, self-promote, or solicit without permission. (Minor if occasional; Major if repeated or aggressive)
  8. Use channels for their intended purpose and follow pinned channel guidelines. (Minor if off-topic once; Major if repeated)
  9. Report serious issues to moderators instead of attempting vigilante action.
  10. Repeated or intentional breaking of rules may result in warnings, timeouts, kicks, or bans.

# Default channel guidelines for all channels.
# Used when a channel hasn't defined custom guidelines via the bot.
default_channel_guidelines: "Be respectful and stay on topic. No spamming, self-promotion, or NSFW content."
