# ========================================
# MODCORD CONFIGURATION
# ========================================
# Modcord's core configuration for AI tuning, moderation logic, and caching.

# ========================================
# 1. CACHE SETTINGS
# ========================================
cache:
  # Refresh interval (seconds) for server rules cache.
  rules_cache_refresh: 60

  # Refresh interval (seconds) for channel guidelines cache.
  channel_guidelines_cache_refresh: 60

# ========================================
# 2. MODERATION SETTINGS
# ========================================

moderation:
  # Messages received within this window (seconds) are grouped for batch moderation.
  # Lower = faster response, higher = better API efficiency.
  moderation_batch_seconds: 15

  # Historical lookback (days) for past moderation actions.
  # Used by AI to determine punishment escalation. Set to 0 to disable.
  past_actions_lookback_days: 7

  # Number of recent messages to fetch for context (including historical messages).
  # Provides context for violations. Recommended: 8-20.
  history_context_messages: 8

# ========================================
# 3. AI MODEL & INFERENCE SETTINGS
# ========================================

ai_settings:
  # Enable/disable AI-based moderation. Set to false to use basic (non-AI) moderation.
  enabled: true

  # Path to local model dir or Hugging Face model identifier (e.g., "Qwen/Qwen3-VL-4B-Instruct").
  model_id: "cpatonn/Qwen3-VL-4B-Instruct-AWQ-4bit"

  # GPU memory utilization (0.0 to 1.0). Reduce if running out of VRAM.
  vram_percentage: 0.86

  # CPU offload size (GB). Set to 0 to disable.
  cpu_offload_gb: 0

  # Sampling parameters for text generation. Controls output creativity and quality.
  sampling_parameters:
    # Computation data type: "auto", "float32", "float16", "bfloat16".
    dtype: "bfloat16"

    # Maximum new tokens to generate in one inference. Moderation typically needs ~512-1024.
    max_new_tokens: 1024

    # Maximum total model context length (input + output tokens).
    # Must be <= model's actual context window (e.g., 4096-8192 for Qwen3-VL-4B).
    max_model_length: 4096

    # Temperature (0.0-1.5): Controls randomness (0.0=deterministic, 0.3=balanced, 0.7=creative).
    # Recommended for moderation: 0.3.
    temperature: 0.3

    # Top-P (nucleus sampling): Keep only top P% probability mass. 0.9 = keep top 90%.
    top_p: 0.9

    # Top-K: Keep only top K most probable tokens (e.g., 40).
    top_k: 40

    # Repetition penalty: Penalizes repeated tokens (>1.0 = penalize). 1.1 avoids spam-like output.
    repetition_penalty: 1.1

    # Presence penalty: Penalizes tokens that have already appeared (>0.0 = penalize).
    presence_penalty: 0.1

    # Frequency penalty: Penalizes tokens proportional to their frequency (>0.0 = penalize).
    frequency_penalty: 0.0

  # =======================================
  # System prompt for the AI moderation model. Guides the model to output a JSON decision.
  # Placeholders: 
  # <|SERVER_RULES_INJECT|>, <|CHANNEL_GUIDELINES_INJECT|>
  # =======================================
  system_prompt: |
    ROLE: You are a Discord moderation AI. Output ONLY valid JSON. No explanations, no extra text.

    INPUT:
    - Consider the JSON input containing channel_id, users, and messages.
    - Only process current messages (is_history: false). 
    - Historical messages provide context ONLY; they must NOT be used as evidence of a violation.
    - A user may ONLY be moderated if their CURRENT messages violate a rule.

    USER DATA:
    Each user object contains:
    - user_id: Discord user ID
    - username: Display name
    - roles: List of role names
    - join_date: When they joined the server
    - messages: Array of messages with content, timestamp, and image_ids
    - past_actions: Past moderation actions taken on this user
      * Use past_actions ONLY to determine escalation IF AND ONLY IF a new violation exists.
      * Never punish a user solely because they have past actions.

    USER ACTIONS:
    - One action per user.
    - Include all users; if no violation, use "action": "null".
    - Valid actions:
      - "null" → no violation
      - "warn" → first-time significant violation
      - "delete" → remove specific current messages that violate rules
      - "timeout" → repeated violations (must set timeout_duration in minutes)
      - "kick" → serious violation
      - "ban" → repeated serious violations (set ban_duration; -1 = permanent, in minutes)
      - "review" → ambiguity or uncertain decision requiring moderator review (DMs moderators with context)

    STRICT RULE:  
    - **Short**, **casual**, **unremarkable**, or **low-effort** messages are NEVER violations unless they explicitly break a listed rule.  
    - NEVER classify normal conversation as spam unless it CLEARLY meets the server’s definition.

    RULES & POLICIES:
    Follow ONLY the rules below exactly as written. Do not infer extra rules. Be lenient to avoid false positives.

    --- Discord Server Rules ---
    <|SERVER_RULES_INJECT|>

    --- Channel-Specific Guidelines ---
    <|CHANNEL_GUIDELINES_INJECT|>

    OUTPUT FORMAT:
    {
      "channel_id": <integer>,
      "users": [
        {
          "user_id": <integer>,
          "action": "null|warn|delete|timeout|kick|ban|review",
          "reason": "factual, concise",
          "message_ids_to_delete": [<message ids to delete, integers only>],
          "timeout_duration": <integer: 0 for no timeout or a positive duration in minutes>,
          "ban_duration": <integer: -1 for permanent, 0 for no ban, or a positive duration in minutes>
        }
      ]
    }

    PROCEDURE:
    1. Ignore all historical messages (is_history=true) for rule-breaking evaluation.
    2. Evaluate ONLY current messages against server rules.
    3. If no current messages, set "action": "null".
    4. If a current message breaks a rule:
      - First violation → "warn"
      - If user has past similar violations → escalate (timeout, kick, ban)
    5. If NO rule is violated → ALWAYS "action": "null", regardless of past actions.
    6. If uncertain that a rule was broken → choose "null" (benefit of the doubt).

    ANTI-BIAS:
    - Do not assume intent.
    - Do not judge users based on message length, frequency, tone, or writing style unless explicitly required by a rule.
    - Escalate ONLY when a NEW violation is detected.


# ========================================
# 4. DEFAULT RULES & GUIDELINES
# ========================================
# These template rules apply to all servers unless overridden via bot commands.

# Default server rules for all servers. Used if no server-specific rules are defined.
default_server_rules: |
  1. Be respectful to all members and moderators.
  2. No spamming, flooding, or excessive use of caps/emoji. (Minor: occasional caps/emoji; Major: repeated spamming)
  3. No hate speech, racism, sexism, homophobia, or any form of discrimination. (Always major)
  4. Keep content appropriate for all ages; no NSFW, graphic violence, or illegal content. (Always major)
  5. Do not share personal information of yourself or others. (Always major)
  6. Follow Discord's Terms of Service and community guidelines. (Major if violated)
  7. Do not advertise, self-promote, or solicit without permission. (Minor if occasional; Major if repeated or aggressive)
  8. Use channels for their intended purpose and follow pinned channel guidelines. (Minor if off-topic once; Major if repeated)
  9. Report serious issues to moderators instead of attempting vigilante action.
  10. Repeated or intentional breaking of rules may result in warnings, timeouts, kicks, or bans.

# Default channel guidelines for all channels. Used if no channel-specific guidelines are defined.
default_channel_guidelines: ""