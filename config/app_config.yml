# ========================================
# MODCORD CONFIGURATION
# ========================================
# This configuration file defines all settings for Modcord, including AI/LLM tuning,
# moderation behavior, and cache refresh intervals.
#
# Sections:
#   1. Cache & Performance Settings
#   2. AI Model & Inference Settings
#   3. Moderation System Prompt
#   4. Default Rules & Guidelines

# ========================================
# 1. CACHE & PERFORMANCE SETTINGS
# ========================================

rules_cache_refresh:
  # Interval (seconds) to refresh server rules and channel guidelines from Discord.
  # Recommended: 3600 (60 minutes). Lower values increase API calls and latency.
  # Higher values reduce API load but may miss fast rule updates.
  interval_seconds: 3600

# ========================================
# 2. AI MODEL & INFERENCE SETTINGS
# ========================================

ai_settings:
  # Enable/disable AI-based moderation. Set to false to use rule-only moderation.
  enabled: true

  # Path to your local model directory or Hugging Face model identifier.
  # Examples:
  #   - Local: "./modcord_custom_models/qwen3-vl-4b-instruct-nf4"
  #   - HuggingFace: "Qwen/Qwen3-VL-4B-Instruct"
  model_id: "./modcord_custom_models/qwen3-vl-4b-instruct-nf4"

  # GPU memory utilization (0.0 to 1.0).
  # 0.86 = use 86% of GPU VRAM. Reduce if running out of memory.
  vram_percentage: 0.86

  # CPU offload size in GB (used when model exceeds available GPU memory).
  # Set to 0 to disable offloading. Increase if model doesn't fit in VRAM.
  cpu_offload_gb: 0

  # Moderation batch window (seconds).
  # Messages received within this window are grouped for batch moderation.
  # Lower values = faster response (more API calls), higher values = better efficiency.
  moderation_batch_seconds: 15

  # Historical context lookback (days) for past moderation actions.
  # When processing current violations, include actions from the past N days.
  # Default: 7 (7 days). Set to 0 to disable context lookback.
  # This helps the AI understand a user's moderation history when making decisions.
  past_actions_lookback_days: 7

  # Number of recent messages to fetch for context when building message history.
  # Higher values provide more context for violations but increase processing time.
  # Recommended: 8-20. Adjust based on channel activity level.
  history_context_messages: 8

  # Sampling parameters for text generation.
  # These control model behavior, creativity, and output quality.
  sampling_parameters:
    # Data type for model computation.
    # Options: "auto" (default), "float32", "float16" (half), "bfloat16" (better than float16).
    dtype: "bfloat16"

    # Maximum number of tokens to generate in a single inference.
    # Higher = more verbose output but slower. Moderation typically needs ~256-512 tokens.
    max_new_tokens: 512

    # Maximum total model context length (input + output tokens).
    # Ensure this is <= model's actual context window.
    # Qwen3-VL-4B: 4096-8192 tokens recommended.
    max_model_length: 4096

    # Temperature (0.0-1.5): Controls randomness/creativity.
    # 0.0 = deterministic (guranteed same output every time)
    # 0.3 = balanced (default)
    # 0.7 = more creative/random
    # For moderation: 0.3 (somewhat deterministic) is recommended.
    temperature: 0.3

    # Top-P (nucleus sampling): Keep only top P% probability mass.
    # 0.9 = keep top 90% of probable tokens, drop bottom 10%.
    # Higher values = more diverse output, lower = more focused.
    top_p: 0.9

    # Top-K: Keep only top K most probable tokens.
    # 40 = consider only top 40 tokens at each step.
    # Lower = more focused, higher = more diverse.
    top_k: 40

    # Repetition penalty: Penalizes repeated tokens.
    # 1.0 = no penalty, >1.0 = penalize repetition.
    # 1.1 is good for avoiding repetitive/spam-like output.
    repetition_penalty: 1.1

    # Presence penalty: Penalizes tokens that have already appeared.
    # 0.0 = disabled, >0.0 = penalize already-used tokens.
    presence_penalty: 0.0

    # Frequency penalty: Penalizes tokens proportional to their frequency.
    # 0.0 = disabled, >0.0 = penalize high-frequency tokens.
    frequency_penalty: 0.0

  # System prompt for the AI moderation model.
  # This guides the model to make moderation decisions in JSON format.
  # Injected placeholders:
  #   <|SERVER_RULES_INJECT|> → Replaced with server_rules or default_server_rules
  #   <|CHANNEL_GUIDELINES_INJECT|> → Replaced with channel-specific guidelines
  system_prompt: |
    ROLE: You are a Discord moderation AI. Output ONLY valid JSON. No explanations, no extra text.

    INPUT:
    - Consider the JSON input containing channel_id, users, and messages.
    - Only process current messages (is_history: false).
    - Historical messages are for context only; do not act on them.
    - Each user includes a "past_actions" field showing their recent moderation history.

    USER DATA:
    Each user object contains:
    - user_id: Discord user ID
    - username: Display name
    - roles: List of role names
    - join_date: When they joined the server
    - messages: Array of messages with content, timestamp, and image_ids
    - past_actions: Array of recent moderation actions taken on this user
      * Each past action includes: action (type), reason, timestamp, and optional duration
      * Use this to understand patterns of behavior and escalate appropriately
      * First-time offenders vs repeat offenders should be treated differently

    USER ACTIONS:
    - One action per user.
    - Include all users; if no violation, use "action": "null".
    - Valid actions:
      - "null" → no violation / not major / ambiguous
      - "warn" → first-time significant violation
      - "delete" → remove specific current messages if they violate rules
      - "timeout" → repeated violations (set timeout_duration in minutes)
      - "kick" → serious violation (set durations null)
      - "ban" → repeated serious violations (set ban_duration; -1 = permanent)

    RULES & POLICIES:
    Follow the rules below strictly when evaluating messages. Do not invent rules, regardless of moral or ethical considerations. Be objective and lenient towards users to avoid false positives.

    --- Discord Server Rules ---
    <|SERVER_RULES_INJECT|>

    --- Channel-Specific Guidelines ---
    <|CHANNEL_GUIDELINES_INJECT|>

    OUTPUT FORMAT:
    {
      "channel_id": "string",
      "users": [
        {
          "user_id": "string",
          "action": "null|warn|delete|timeout|kick|ban",
          "reason": "factual, concise",
          "message_ids_to_delete": ["current IDs only, no duplicates"],
          "timeout_duration": number|0,
          "ban_duration": number|0
        }
      ]
    }
    - Only include current message IDs.
    - Ensure durations match the action type.
    - Include all users, one action per user, no duplicates.

    PROCEDURE:
    1. Use historical messages (is_history: true) **only for context**, never to determine actions.
    2. Review each user's past_actions to understand their moderation history.
    3. If a user has no current messages → "action": "null".
    4. Evaluate current messages strictly against server rules and channel guidelines.
    5. For minor or first-time violations (no past_actions or empty past_actions) → issue "warn" or "null".
    6. If specific messages violate rules → mark them for "delete".
    7. For users with past violations (non-empty past_actions) → escalate appropriately:
       - Recent warns → consider timeout
       - Recent timeout → consider longer timeout or kick
       - Recent kick or multiple timeouts → consider ban
    8. Repeated or severe violations → escalate to "timeout", "kick", or "ban" as appropriate.
    9. Always ensure all users are included, only one action per user, message IDs are current, and durations match the action type.

    ANTI-BIAS:
    - Treat all users equally, regardless of username, style, or tone.
    - Do not assume intent or extrapolate beyond the text provided.
    - If a message includes `image_ids`, judge the images according to server rules.
    - Use past_actions objectively to determine appropriate escalation, not to pre-judge users.

# ========================================
# 4. DEFAULT RULES & GUIDELINES
# ========================================
# These are template rules that apply to all servers unless overridden per-guild.
# To customize per-guild, use the Discord bot commands to set server-specific rules.

# Default server rules for all servers.
# Used when a server hasn't defined custom rules via the bot.
# Rules are displayed to users and used by the AI moderation model.
default_server_rules: |
  1. Be respectful to all members and moderators.
  2. No spamming, flooding, or excessive use of caps/emoji. (Minor: occasional caps/emoji; Major: repeated spamming)
  3. No hate speech, racism, sexism, homophobia, or any form of discrimination. (Always major)
  4. Keep content appropriate for all ages; no NSFW, graphic violence, or illegal content. (Always major)
  5. Do not share personal information of yourself or others. (Always major)
  6. Follow Discord's Terms of Service and community guidelines. (Major if violated)
  7. Do not advertise, self-promote, or solicit without permission. (Minor if occasional; Major if repeated or aggressive)
  8. Use channels for their intended purpose and follow pinned channel guidelines. (Minor if off-topic once; Major if repeated)
  9. Report serious issues to moderators instead of attempting vigilante action.
  10. Repeated or intentional breaking of rules may result in warnings, timeouts, kicks, or bans.

# Default channel guidelines for all channels.
# Used when a channel hasn't defined custom guidelines via the bot.
default_channel_guidelines: "Be respectful and stay on topic. No spamming, self-promotion, or NSFW content."
